<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EM</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="styles/smart-main.css">
  </head>
  <body>
    <div class="container">
        <nav id = "topnav">
            <a id = "em-logo" href="/"><img src = "images/smart_solutions/EM.jpg" alt="Empire Logo"></a>
            <input class = "search-area" type="text" placeholder="Search for a Solution..">
            <a id="lgn-btn">Login</a>
        </nav>
        <div id="hero">
          <svg id= "circuitSvg" preserveAspectRatio="xMidYMid meet">
          </svg>
          <div id="systems">
            
          </div>
        </div>
        <div id="content">
          <div class="solution-section">
            <div class = "section--header">Vision Section</div>
            <div class="sub-solutions">
              <div class="soln--card">
                <img src="images/smart_solutions/EM.jpg" alt="image">
                <div>
                  <div class="soln-desc">
  
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
    </div>
  </body>
  <script>
    const svg = document.getElementById("circuitSvg");
    const subSystems = [
      {
        name : "vision-systems",
        trailer : "videos/smart_solutions/detection.mp4",
        backgroundImage : "images/smart_solutions/EM.jpg",
        position : {x : 0, y : 0},
        subElements : [
          {
            name : "Detection" ,
            short :  "videos/smart_solutions/detection.mp4",
            link : "detection"
          },
          {
            name : "Tracking" ,
            short :  "videos/smart_solutions/tracking.mp4",
            link : "tracking"
          },
          {
            name : "Segmentation" ,
            short :  "videos/smart_solutions/segmentation.mp4",
            link : "segmentation"
          },
        ]
      },
      {
        name : "Language-models",
        trailer : "videos/smart_solutions/segmentation.mp4",
        backgroundImage : "images/smart_solutions/EM.jpg",
        position : {x : 0, y : 0},
        subElements : [
          {
            name : "Chat Bot" ,
            short :  "videos/smart_solutions/detection.mp4",
            link : "detection"
          },
          {
            name : "Image Generation" ,
            short :  "videos/smart_solutions/tracking.mp4",
            link : "tracking"
          }
        ]
      },
      {
        name : "Time-Series-models",
        trailer : "videos/smart_solutions/segmentation.mp4",
        backgroundImage : "images/smart_solutions/EM.jpg",
        position : {x : 0, y : 0},
        subElements : [
          {
            name : "Trading" ,
            short :  "videos/smart_solutions/detection.mp4",
            link : "detection"
          }
        ]
      },
      {
        name : "Misc",
        trailer : "videos/smart_solutions/segmentation.mp4",
        backgroundImage : "images/smart_solutions/EM.jpg",
        position : {x : 0, y : 0},
        subElements : [
          {
            name : "Probability" ,
            short :  "videos/smart_solutions/detection.mp4",
            link : "detection"
          }
        ]
      }
    ]
    
    function subsystemListOnHoverEvent(e, videoContainerElement, elementsList) {
      const link = e.target.closest('a');
      const sourceElement = videoContainerElement.querySelector('source');
      const videoElement = videoContainerElement.querySelector('video'); 

      if (!link || !elementsList.contains(link))
      {
        videoElement.pause();
        return;
      } 

      const newSrc = link.getAttribute('data-video');
      if (sourceElement.getAttribute('src') !== newSrc) {
        sourceElement.setAttribute('src', newSrc);
        videoElement.load();
      }
      videoElement.style.opacity = 0.7;
      videoElement.parentElement.style.backgroundImage = 'none';
      videoElement.play();
    }

    function subsystemListOnMouseLeave(videoContainerElement, defaultVideoSrc, backgroundImage) {
      const sourceElement = videoContainerElement.querySelector('source');
      const videoElement = videoContainerElement.querySelector('video');

      sourceElement.setAttribute('src', defaultVideoSrc);
      videoElement.load();
      videoElement.pause();
      videoElement.style.opacity = 0;
      videoElement.parentElement.style.backgroundImage = `url(${backgroundImage})`;
    }

    function createSystemShort(trailer, backgroundImage) {
      // Create video element
      const subSystemShort = document.createElement('div');
      subSystemShort.setAttribute("class", "system-shorts");

      const video = document.createElement('video');
      video.setAttribute("loop", "");
      video.setAttribute("muted", "");
      video.muted = true;
      video.setAttribute("preload", "auto");

      // Create and append source element
      const source = document.createElement('source');
      source.setAttribute('src', trailer); // set your path
      source.setAttribute('type', 'video/mp4');
      video.appendChild(source);

      // Add listener for entering video element area
      subSystemShort.addEventListener('mouseenter', () => {
        source.setAttribute('src', trailer);
        video.load();
        video.play();
        video.style.opacity = 0.7;
        subSystemShort.style.backgroundImage = 'none';
      });

      // Add listener for leaving video element area
      subSystemShort.addEventListener('mouseleave', () => {
        video.pause();
        subSystemShort.style.backgroundImage = `url(${backgroundImage})`;
        video.style.opacity = 0;
      });

      subSystemShort.appendChild(video);

      return subSystemShort;
    }

    function createSystemSubElements(subElements, videoContainerElement, defaultVideoSrc, backgroundImage) {
      // Create list element
      const elementsList = document.createElement('ul');
      elementsList.setAttribute('class', 'hero-list');

      // Create each element in list
      subElements.forEach(element => {
        const listElement = document.createElement('li');
        const anchorElement = document.createElement('a');
        anchorElement.textContent = element.name;
        anchorElement.setAttribute("href", element.link);
        anchorElement.setAttribute("data-video", element.short);
        listElement.appendChild(anchorElement);
        elementsList.appendChild(listElement);
      });

      elementsList.addEventListener('mouseover', (e) => {
        subsystemListOnHoverEvent(e, videoContainerElement, elementsList);
      });
      
      elementsList.addEventListener('mouseleave', () => {
        subsystemListOnMouseLeave(videoContainerElement, defaultVideoSrc, backgroundImage);
      });

      return elementsList;
    }

    function createMainLines(circuitLines) {

      circuitLines.forEach(LineConfig => {
        const line = document.createElementNS("http://www.w3.org/2000/svg", "path");
        line.setAttribute("d", `M ${LineConfig.startX} ${LineConfig.startY} L ${LineConfig.startX + LineConfig.movementsXOffsets[0]} ${LineConfig.startY + LineConfig.movementsYOffsets[0]} l ${LineConfig.movementsXOffsets[1]} ${LineConfig.movementsYOffsets[1]} l ${LineConfig.movementsXOffsets[2]} ${LineConfig.movementsYOffsets[2]}`)
        line.setAttribute("stroke", "#0ff");
        line.setAttribute("stroke-width", "2");
        line.setAttribute("fill", "None");
        line.setAttribute("filter", "url(#glow)");
        svg.appendChild(line);
      });

    }

    function createSubSystems(subSystems, width) {
      const systemsDiv = document.querySelector('#systems');
      systemsDiv.innerHTML = '';
      
      for (const system of subSystems) {
        // Create container div
        const subSystemDiv = document.createElement('div');
        subSystemDiv.setAttribute("id", system.name);
        subSystemDiv.setAttribute("class", "sub-system");

        // Create system shorts video
        const shortsVideoElement = createSystemShort(system.trailer, system.backgroundImage);

        // Create list of elements inside subsystem
        const subElementsList = createSystemSubElements(system.subElements, shortsVideoElement, system.trailer, system.backgroundImage);

        // Conditionally append: list first for left side, video first for right side
        if (system.position.x < width / 2) {
          subSystemDiv.appendChild(subElementsList);   // List first
          subSystemDiv.appendChild(shortsVideoElement); // Then video
        } else {
          subSystemDiv.appendChild(shortsVideoElement); // Video first
          subSystemDiv.appendChild(subElementsList);   // Then list
        }

        systemsDiv.appendChild(subSystemDiv);

        const div = document.querySelector(`#${system.name}`);
        if (system.position.x < width / 2) {
          const divWidth = div.offsetWidth;
          div.style.left = `${system.position.x - divWidth}px`;
        } else {
          div.style.left = `${system.position.x}px`;
        }
        div.style.top = `${system.position.y}px`;
      }
    }
    
    function drawCircuit() {
      const SVG_NS = "http://www.w3.org/2000/svg";
      svg.innerHTML = `<defs>
                        <filter id="glow">
                          <feDropShadow dx="0" dy="0" stdDeviation="3" flood-color="#0ff" />
                          <feDropShadow dx="0" dy="0" stdDeviation="6" flood-color="#0ff" />
                        </filter>
                      </defs>`; // clear lines but keep defs

      // Get width, height and calculate needed size and coordinates
      const width = svg.clientWidth;
      const height = svg.clientHeight;
      const rectSize = svg.clientWidth / 8;
      const centerX = width / 2;
      const centerY = height / 2;

      // Create rectangle according to the window/svg size
      const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
      rect.setAttribute("x", centerX - rectSize / 2);
      rect.setAttribute("y", centerY - rectSize / 2);
      rect.setAttribute("width", rectSize);
      rect.setAttribute("height", rectSize);
      rect.setAttribute("fill", "#00415a");
      rect.setAttribute("filter", "url(#glow)");
      svg.appendChild(rect);

      const mainCircutLines = [
        // top right
        {
          startX : centerX + rectSize / 2,
          startY : centerY - 0.7 * (rectSize / 2),
          movementsXOffsets : [width/10, 0, width/10],
          movementsYOffsets : [0, -width/10, 0],
        },// bottom right
        {
          startX : centerX + rectSize / 2,
          startY : centerY + 0.7 * (rectSize / 2),
          movementsXOffsets : [width/10, 0, width/10],
          movementsYOffsets : [0, width/10, 0],
        },// top left
        {
          startX : centerX - rectSize / 2,
          startY : centerY - 0.7 * (rectSize / 2),
          movementsXOffsets : [-width/10, 0, -width/10],
          movementsYOffsets : [0, -width/10, 0],
        },
        {
          startX : centerX - rectSize / 2,
          startY : centerY + 0.7 * (rectSize / 2),
          movementsXOffsets : [-width/10, 0, -width/10],
          movementsYOffsets : [0, width/10, 0],
        }
      ]

      // Create main lines
      createMainLines(mainCircutLines, svg);

      const systems = document.querySelector("#systems");

      subSystems.forEach((val, i) => {
        const LineConfig = mainCircutLines[i];
        const endX = LineConfig.startX + LineConfig.movementsXOffsets[0] + LineConfig.movementsXOffsets[1] + LineConfig.movementsXOffsets[2];
        const endY = LineConfig.startY + LineConfig.movementsYOffsets[0] + LineConfig.movementsYOffsets[1] + LineConfig.movementsYOffsets[2];
        console.log(`SUBSYSTEM ${i}`)
        console.log(`endX : ${endX}`)
        console.log(`endY : ${endY}`)

        if (endX < width/2) {
          console.log(`position left endX = ${endX}`)
          subSystems[i].position = {x : endX - 0.05 * rectSize, y : endY - Math.abs(LineConfig.movementsYOffsets[1]) / 2};
        } else{
          subSystems[i].position = {x : endX + 0.05 * rectSize, y : endY - Math.abs(LineConfig.movementsYOffsets[1]) / 2};
        }
      });

      // Create vision systems div
      createSubSystems(subSystems, width);

    }
     
    drawCircuit();
    window.addEventListener("resize", drawCircuit);

  </script>
</html>